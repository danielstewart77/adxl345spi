#!/bin/bash
set -e

# Define the installation directory and virtual environment path
INSTALL_DIR="/opt/redoak"
VENV_DIR="$INSTALL_DIR/venv"

# Create the installation directory if it doesn't exist
if [ ! -d "$INSTALL_DIR" ]; then
    mkdir -p "$INSTALL_DIR"
fi

# Create a virtual environment
echo "Creating virtual environment..."
python3 -m venv "$VENV_DIR"

# Activate the virtual environment and install dependencies
echo "Installing Python dependencies in the virtual environment..."
"$VENV_DIR/bin/pip" install --upgrade pip setuptools
if [ -f "$INSTALL_DIR/requirements.txt" ]; then
    "$VENV_DIR/bin/pip" install -r "$INSTALL_DIR/requirements.txt"
fi

# Clone the Git repository if necessary
if [ ! -d "$INSTALL_DIR/app" ]; then
    git clone https://github.com/danielstewart77/adxl345spi "$INSTALL_DIR/app"
fi

# Make the Python script executable
chmod +x "$INSTALL_DIR/app/web.py"

# Create a launcher script
cat <<EOF > /usr/local/bin/redoak-launcher
#!/bin/bash
"$VENV_DIR/bin/python" "$INSTALL_DIR/app/web.py"
EOF
chmod +x /usr/local/bin/redoak-launcher

# Configure system startup
cat <<EOF > /etc/systemd/system/redoak.service
[Unit]
Description=RedOak Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/redoak-launcher
Restart=always

[Install]
WantedBy=default.target
EOF

# Enable and start the systemd service
systemctl enable redoak.service
systemctl start redoak.service

echo "Installation complete. RedOak is ready to use."
